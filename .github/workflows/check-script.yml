name: 00 - Validate Setup Script (Fast Check)

on:
  push:
    paths:
      - 'diy-part2.sh'
      - '.github/workflows/check-script.yml'
  workflow_dispatch:

jobs:
  dry_run_check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Mock Environment (Simulation)
        run: |
          echo ">>> Setting up dummy OpenWrt environment..."
          # 1. åˆ›å»º OpenWrt ç›®å½•ç»“æ„
          mkdir -p package/boot/uboot-sunxi/patches
          mkdir -p target/linux/sunxi/image
          
          # 2. åˆ›å»º Dummy Makefile (å¿…é¡»åŒ…å« grep å…³é”®å­—ä¾›è„šæœ¬ä¿®æ”¹)
          cat <<EOF > package/boot/uboot-sunxi/Makefile
          # Dummy Makefile
          define BuildPackage/U-Boot
          endef
          UBOOT_TARGETS := old_target
          EOF
          
          # 3. åˆ›å»º Dummy Image Makefile
          echo "CONFIG_SUNXI_UBOOT_BIN_OFFSET=128" > target/linux/sunxi/image/Makefile
          
          # 4. åˆ›å»º Dummy .config
          echo "CONFIG_PACKAGE_uboot-sunxi=y" > .config
          
          # 5. èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™
          chmod +x diy-part2.sh

      - name: Run diy-part2.sh
        run: |
          echo ">>> Running script..."
          ./diy-part2.sh

      - name: Verify Results
        run: |
          echo ">>> Verifying generated patches..."
          PATCH_CONF="package/boot/uboot-sunxi/patches/999-add-t113-tronlong-defconfig.patch"
          PATCH_DTS_DATA="package/boot/uboot-sunxi/patches/998-add-t113-tronlong-dts-file.patch"
          PATCH_DTS_MAKE="package/boot/uboot-sunxi/patches/997-add-t113-tronlong-dts-makefile.patch"
          
          # Check 1: Defconfig Patch
          if [ -f "$PATCH_CONF" ]; then
            echo "âœ… Defconfig Patch created."
            if grep -q "+CONFIG_DRAM_ZQ=8092667" "$PATCH_CONF"; then
               echo "   -> Content verification PASSED (ZQ Found)."
            else
               echo "   -> âŒ Content verification FAILED (ZQ Missing)."
               cat "$PATCH_CONF"
               exit 1
            fi
          else
            echo "âŒ Defconfig Patch NOT created!"
            exit 1
          fi

          # Check 2: DTS File Patch (New split file)
          if [ -f "$PATCH_DTS_DATA" ]; then
            echo "âœ… DTS Data Patch created."
            if grep -q "bootph-all;" "$PATCH_DTS_DATA"; then
               echo "   -> Content verification PASSED (bootph-all Found)."
            else
               echo "   -> âŒ Content verification FAILED (bootph-all Missing)."
               cat "$PATCH_DTS_DATA"
               exit 1
            fi
          else
            echo "âŒ DTS Data Patch NOT created!"
            exit 1
          fi

          # Check 3: Makefile Registry Patch (New split file)
          if [ -f "$PATCH_DTS_MAKE" ]; then
            echo "âœ… DTS Makefile Patch created."
            if grep -q "allwinner/sun8i-t113-tronlong.dtb" "$PATCH_DTS_MAKE"; then
               echo "   -> Content verification PASSED (Path registered)."
            else
               echo "   -> âŒ Content verification FAILED (Path registry Missing)."
               cat "$PATCH_DTS_MAKE"
               exit 1
            fi
          else
            echo "âŒ DTS Makefile Patch NOT created!"
            exit 1
          fi
          
          echo "ğŸ‰ All Checks Passed! diy-part2.sh is ready for U-Boot 2025.01."
