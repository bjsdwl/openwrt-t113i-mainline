name: 00 - Validate Setup Script (Fast Check)

on:
  push:
    paths:
      - 'diy-part2.sh'
      - '.github/workflows/check-script.yml'
  workflow_dispatch:

jobs:
  dry_run_check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Mock OpenWrt Structure
        run: |
          echo ">>> Mocking OpenWrt directory structure..."
          # 1. åˆ›å»ºè¡¥ä¸å­˜æ”¾æºï¼ˆæ¨¡æ‹Ÿä½ çš„ä»£ç åº“ï¼‰
          mkdir -p patches-uboot
          touch patches-uboot/001-test.patch
          touch patches-uboot/002-test.patch
          
          # 2. åˆ›å»ºç›®æ ‡ç›®å½•ï¼ˆæ¨¡æ‹Ÿ OpenWrt æºç ç›®å½•ï¼‰
          mkdir -p package/boot/uboot-sunxi/patches
          mkdir -p target/linux/sunxi/image
          
          # 3. åˆ›å»ºåŸå§‹ Makefile (å¸¦æˆªèƒ¡ç‚¹)
          cat <<EOF > package/boot/uboot-sunxi/Makefile
          # Original Makefile
          define BuildPackage/U-Boot
          endef
          EOF
          
          # 4. åˆ›å»ºåŸå§‹ Image Makefile (å¸¦ 128KB åç§»)
          cat <<EOF > target/linux/sunxi/image/Makefile
          CONFIG_SUNXI_UBOOT_BIN_OFFSET=128
          dd if=u-boot.bin of=sd.img bs=1k seek=128
          EOF
          
          chmod +x diy-part2.sh

      - name: Run diy-part2.sh
        run: |
          echo ">>> Running diy-part2.sh..."
          # æ¨¡æ‹Ÿ GitHub Actions çš„ç¯å¢ƒå˜é‡
          export GITHUB_WORKSPACE=$GITHUB_WORKSPACE
          ./diy-part2.sh

      - name: Verify Logic Results
        run: |
          echo ">>> Verifying script execution results..."
          
          # 1. éªŒè¯è¡¥ä¸æ˜¯å¦æ¬è¿æˆåŠŸ
          if [ -f "package/boot/uboot-sunxi/patches/001-test.patch" ]; then
            echo "âœ… Patch migration: PASSED"
          else
            echo "âŒ Patch migration: FAILED (Files not copied)"
            exit 1
          fi
          
          # 2. éªŒè¯ Makefile æˆªèƒ¡æ˜¯å¦æˆåŠŸ
          if grep -q "UBOOT_TARGETS := allwinner_t113_tronlong" package/boot/uboot-sunxi/Makefile; then
            echo "âœ… Makefile Hijack: PASSED"
          else
            echo "âŒ Makefile Hijack: FAILED"
            grep "UBOOT_TARGETS" package/boot/uboot-sunxi/Makefile || echo "No UBOOT_TARGETS found"
            exit 1
          fi
          
          # 3. éªŒè¯é•œåƒåç§»ä¿®æ”¹ (128 -> 8)
          if grep -q "OFFSET=8" target/linux/sunxi/image/Makefile && grep -q "seek=16" target/linux/sunxi/image/Makefile; then
            echo "âœ… Image Offset Modification: PASSED"
          else
            echo "âŒ Image Offset Modification: FAILED"
            cat target/linux/sunxi/image/Makefile
            exit 1
          fi
          
          echo "ğŸ‰ All Script Logic Checks Passed!"
