name: 00 - Validate Setup Script (Fast Check)

on:
  push:
    paths:
      - 'diy-part2.sh'
      - '.github/workflows/check-script.yml'
  workflow_dispatch:

jobs:
  dry_run_check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Syntax & Permission Check
        run: |
          echo ">>> 1. Checking Bash Syntax..."
          bash -n diy-part2.sh
          if [ $? -eq 0 ]; then echo "[OK] Syntax looks good."; else echo "[FAIL] Syntax error."; exit 1; fi

          echo ">>> 2. Checking Execution Permissions..."
          chmod +x diy-part2.sh
          if [ -x diy-part2.sh ]; then echo "[OK] Script is executable."; else echo "[FAIL] Script is NOT executable."; exit 1; fi

      - name: Mock Environment (Simulation)
        run: |
          echo ">>> 3. Creating Dummy Files for Simulation..."
          # æ¨¡æ‹Ÿ OpenWrt çš„ç›®å½•ç»“æ„ï¼Œé˜²æ­¢ sed æŠ¥é”™
          mkdir -p package/boot/uboot-sunxi
          mkdir -p target/linux/sunxi/image
          
          # æ¨¡æ‹Ÿ U-Boot Makefile (å¿…é¡»åŒ…å«è„šæœ¬ grep çš„å…³é”®å­—)
          cat <<EOF > package/boot/uboot-sunxi/Makefile
          # Dummy Makefile
          define BuildPackage/U-Boot
          endef
          UBOOT_TARGETS := old_target
          EOF
          
          # æ¨¡æ‹Ÿ Image Makefile
          echo "CONFIG_SUNXI_UBOOT_BIN_OFFSET=128" > target/linux/sunxi/image/Makefile
          echo "seek=128" >> target/linux/sunxi/image/Makefile
          
          # æ¨¡æ‹Ÿ .config
          echo "CONFIG_PACKAGE_uboot-sunxi=y" > .config

      - name: Run diy-part2.sh
        run: |
          echo ">>> 4. Running the script..."
          ./diy-part2.sh

      - name: Verify Logic (Assertions)
        run: |
          echo ">>> 5. Verifying Results..."
          
          # éªŒè¯ç‚¹ A: è¡¥ä¸æ–‡ä»¶æ˜¯å¦ç”Ÿæˆï¼Ÿ
          PATCH_FILE="package/boot/uboot-sunxi/patches/999-add-t113-industrial-defconfig.patch"
          if [ -f "$PATCH_FILE" ]; then
            echo "[OK] Patch file created at $PATCH_FILE"
          else
            echo "[FAIL] Patch file NOT created!"
            exit 1
          fi

          # éªŒè¯ç‚¹ B: è¡¥ä¸æ ¼å¼æ˜¯å¦åˆæ³• (å…³é”®æ£€æŸ¥ç‚¹ï¼šæ˜¯å¦åŒ…å« + å·å‰ç¼€)
          # è¿™æ˜¯å¯¼è‡´ä½ ä¸Šä¸€æ¬¡å¤±è´¥çš„æ ¸å¿ƒåŸå› ï¼Œå¿…é¡»æ£€æŸ¥ï¼
          if grep -q "^+CONFIG_ARM=y" "$PATCH_FILE"; then
            echo "[OK] Patch format correct (found '+' prefix)."
          else
            echo "[FAIL] Patch format MALFORMED! Lines do not start with '+'."
            echo "--- DUMPING PATCH CONTENT ---"
            head -n 20 $PATCH_FILE
            exit 1
          fi

          # éªŒè¯ç‚¹ C: Makefile æ˜¯å¦è¢«æˆªèƒ¡
          if grep -q "UBOOT_TARGETS := allwinner_t113_s3" package/boot/uboot-sunxi/Makefile; then
             echo "[OK] Makefile hijacked successfully."
          else
             echo "[FAIL] Makefile was NOT modified correctly."
             cat package/boot/uboot-sunxi/Makefile
             exit 1
          fi

          # éªŒè¯ç‚¹ D: .config æ˜¯å¦è¢«é”å®š
          if grep -q "CONFIG_PACKAGE_uboot-sunxi-allwinner_t113_s3=y" .config; then
             echo "[OK] .config locked to T113-S3."
          else
             echo "[FAIL] .config check failed."
             exit 1
          fi

          echo "ğŸ‰ All Checks Passed! diy-part2.sh is valid."
