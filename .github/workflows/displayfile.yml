name: T113-i Reconnaissance (Fetch & Dump)

on:
  workflow_dispatch:

jobs:
  recon:
    runs-on: ubuntu-22.04
    steps:
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker image prune --all --force

      - name: Prepare OpenWrt Source
        run: |
          git clone --depth=1 https://github.com/openwrt/openwrt.git openwrt
          cd openwrt
          # ä»…æ›´æ–° feed ä»¥èŽ·å– uboot-sunxi åŒ…å®šä¹‰
          ./scripts/feeds update -a
          ./scripts/feeds install uboot-sunxi
          
          # ç”Ÿæˆä¸€ä¸ªæœ€å°é…ç½®ä»¥è§¦å‘ toolchain å‡†å¤‡ï¼ˆè™½ç„¶æˆ‘ä»¬ä¸ç¼–è¯‘ï¼‰
          echo "CONFIG_TARGET_sunxi=y" > .config
          echo "CONFIG_TARGET_sunxi_cortexa7=y" >> .config
          make defconfig

      - name: Fetch U-Boot Source (Prepare Only)
        run: |
          cd openwrt
          # æ‰§è¡Œ prepare é˜¶æ®µï¼Œè¿™ä¼šä¸‹è½½ u-boot æºç å¹¶è§£åŽ‹åˆ° build_dir
          make package/boot/uboot-sunxi/prepare V=s

      - name: "ðŸ•µï¸ SCOUTING: Dump Critical Files"
        run: |
          # å®šä½ U-Boot æºç ç›®å½•
          UBOOT_DIR=$(find openwrt/build_dir -type d -name "u-boot-2025.01" | head -n 1)
          echo ">>> Target U-Boot Directory: $UBOOT_DIR"
          
          echo "=================================================================="
          echo "FILE: configs/orangepi_one_defconfig"
          echo "=================================================================="
          cat "$UBOOT_DIR/configs/orangepi_one_defconfig"
          echo -e "\n\n"
          
          echo "=================================================================="
          echo "FILE: arch/arm/dts/sun8i-h3-orangepi-one.dts"
          echo "=================================================================="
          cat "$UBOOT_DIR/arch/arm/dts/sun8i-h3-orangepi-one.dts"
          echo -e "\n\n"
          
          echo "=================================================================="
          echo "FILE: arch/arm/dts/sunxi-u-boot.dtsi (Binman Source)"
          echo "=================================================================="
          # è¿™ä¸ªæ–‡ä»¶é€šå¸¸å®šä¹‰äº†é€šç”¨çš„ binman ç»“æž„
          if [ -f "$UBOOT_DIR/arch/arm/dts/sunxi-u-boot.dtsi" ]; then
            cat "$UBOOT_DIR/arch/arm/dts/sunxi-u-boot.dtsi"
          else
            echo "File not found!"
          fi
          echo -e "\n\n"
