name: 01 - Patch Lint & Validator

on:
  push:
    paths:
      - 'patches-uboot/**'
      - '.github/workflows/check-patches.yml'
  workflow_dispatch:

jobs:
  validate_patches:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Mock U-Boot Tree (2025.01 Structure)
        run: |
          echo ">>> Creating a mock U-Boot 2025.01 environment for testing..."
          # åˆ›å»ºä¸»çº¿ U-Boot 2025.01 è¦æ±‚çš„å­ç›®å½•ç»“æ„
          mkdir -p mock-uboot/arch/arm/dts/allwinner
          mkdir -p mock-uboot/configs
          
          # åˆ›å»ºæ¨¡æ‹Ÿçš„ Makefile (è·¯å¾„: arch/arm/dts/allwinner/Makefile)
          # æ³¨æ„ï¼šå†…å®¹å¿…é¡»åŒ…å«è¡¥ä¸ 001 æœç´¢çš„ä¸Šä¸‹æ–‡å†…å®¹
          cat <<EOF > mock-uboot/arch/arm/dts/allwinner/Makefile
          # SPDX-License-Identifier: GPL-2.0+
          dtb-\$(CONFIG_MACH_SUN8I) += \\
          	sun8i-a23-gt90h.dtb \\
          	sun8i-a23-icell-way-g7.dtb
          EOF
          
          echo ">>> Mock environment ready at mock-uboot/"

      - name: Validate Patch Syntax & Integrity
        run: |
          ERROR_COUNT=0
          cd patches-uboot
          
          for patchfile in *.patch; do
            echo "--------------------------------------------------"
            echo "ğŸ” Testing Patch: $patchfile"
            
            # 1. æ£€æŸ¥æœ«å°¾æ¢è¡Œç¬¦ (é˜²æ­¢ "unexpected end of file" æŠ¥é”™)
            # ä½¿ç”¨ tail æ£€æŸ¥æ–‡ä»¶æœ€åä¸€ä¸ªå­—èŠ‚æ˜¯å¦ä¸ºæ¢è¡Œç¬¦
            if [ -n "$(tail -c 1 "$patchfile")" ]; then
              echo "âŒ ERROR: Patch '$patchfile' does not end with a newline!"
              echo "   (This is required by the 'patch' utility in OpenWrt)"
              ERROR_COUNT=$((ERROR_COUNT + 1))
            else
              echo "âœ… Newline check passed."
            fi
            
            # 2. æ£€æŸ¥åŸºæœ¬ Unified Diff ç»“æ„ (å¿…é¡»å«æœ‰ ---, +++, @@)
            if grep -q "^--- " "$patchfile" && grep -q "^+++ " "$patchfile" && grep -q "^@@ " "$patchfile"; then
              echo "âœ… Unified Diff structure looks valid."
            else
              echo "âŒ ERROR: Patch '$patchfile' is not a valid Unified Diff!"
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
          done
          
          if [ $ERROR_COUNT -ne 0 ]; then
            echo "--------------------------------------------------"
            echo "âŒ Total $ERROR_COUNT critical errors found in patches."
            exit 1
          fi

      - name: Dry-run Apply Patches
        run: |
          echo ">>> Attempting to apply patches to mock tree..."
          cd mock-uboot
          
          # æŒ‰é¡ºåºé¢„æ¼”è¡¥ä¸åº”ç”¨
          for patch in ../patches-uboot/*.patch; do
            echo "ğŸ§ª Dry-running $patch..."
            # -p1 æ˜¯ OpenWrt é»˜è®¤ä½¿ç”¨çš„ strip å±‚çº§
            # --dry-run ä»…åšæµ‹è¯•ï¼Œä¸å®é™…ä¿®æ”¹æ–‡ä»¶
            if patch -p1 --dry-run < "$patch"; then
              echo "âœ… $patch applied successfully (Dry-run)."
            else
              echo "âŒ ERROR: $patch FAILED to apply! Check paths or hunk context."
              exit 1
            fi
          done
          
          echo "ğŸ‰ All patches are syntactically correct and compatible with U-Boot 2025.01!"
