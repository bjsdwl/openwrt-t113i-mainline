name: 01 - Patch Lint & Validator (Real Source Mode)

on:
  push:
    paths:
      - 'patches-uboot/**'
      - '.github/workflows/check-patches.yml'
  workflow_dispatch:

jobs:
  real_source_check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout User Patches
        uses: actions/checkout@v4

      - name: Install Quilt & Utils
        run: |
          sudo apt-get update
          sudo apt-get install -y quilt dos2unix

      - name: 1. Strict Syntax & EOL Check
        run: |
          echo ">>> Checking for Windows CRLF and Missing Newlines..."
          cd patches-uboot
          for patchfile in *.patch; do
            if grep -U $'\r' "$patchfile" > /dev/null; then
              echo "âŒ ERROR: Windows CRLF found in $patchfile"
              exit 1
            fi
            if [ "$(tail -c 1 "$patchfile" | xxd -p)" != "0a" ]; then
               echo "âŒ ERROR: No newline at EOF in $patchfile"
               exit 1
            fi
          done
          echo "âœ… Patch formatting is clean."

      - name: 2. Download Real U-Boot v2025.01
        run: |
          echo ">>> Cloning U-Boot v2025.01 (Shallow)..."
          git clone --depth 1 https://github.com/u-boot/u-boot.git -b v2025.01 u-boot-src

      - name: 3. Quilt Apply Test (Real Source)
        run: |
          cd u-boot-src
          mkdir patches
          cp ../patches-uboot/*.patch patches/
          
          # ã€æ–°å¢žã€‘åœ¨æ ¡éªŒå‰ä¿®å¤å¯èƒ½å­˜åœ¨çš„ç©ºæ ¼/Tab è½¬æ¢é—®é¢˜
          sed -i 's/^        /\t/' patches/003-early-debug-led.patch
          
          ls patches/*.patch | xargs -n 1 basename > patches/series
          
          echo ">>> Attempting to apply patches to REAL v2025.01 source..."
          if quilt push -a --fuzz=0; then
            echo "ðŸŽ‰ SUCCESS: All patches applied perfectly!"
          else
            echo "ðŸ’¥ FAILED: Patch application failed."
            echo ">>> [DEBUG] Context Check (Line 471):"
            sed -n '471p' arch/arm/mach-sunxi/board.c | cat -A
            exit 1
          fi
