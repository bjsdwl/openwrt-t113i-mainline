name: 01 - Patch Lint & Validator (Quilt Mode)

on:
  push:
    paths:
      - 'patches-uboot/**'
      - '.github/workflows/check-patches.yml'
  workflow_dispatch:

jobs:
  strict_quilt_check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Quilt & Utils
        run: |
          sudo apt-get update
          sudo apt-get install -y quilt dos2unix

      - name: 1. Strict Syntax & EOL Check
        run: |
          echo ">>> Checking for Windows CRLF and Missing Newlines..."
          ERROR_COUNT=0
          cd patches-uboot
          
          for patchfile in *.patch; do
            echo "--------------------------------------------------"
            echo "ğŸ” Inspecting: $patchfile"
            
            # 1. CRLF Check
            if grep -U $'\r' "$patchfile" > /dev/null; then
              echo "âŒ CRITICAL ERROR: Found Windows CRLF line endings in $patchfile!"
              echo "   -> Please convert this file to UNIX (LF)."
              ERROR_COUNT=$((ERROR_COUNT + 1))
            else
              echo "âœ… Line endings are UNIX (LF)."
            fi

            # 2. Missing Newline at EOF Check
            LAST_CHAR=$(tail -c 1 "$patchfile" | xxd -p)
            if [ "$LAST_CHAR" != "0a" ]; then
               echo "âŒ CRITICAL ERROR: $patchfile does NOT end with a newline (0x0A)!"
               echo "   Current last byte hex: $LAST_CHAR"
               ERROR_COUNT=$((ERROR_COUNT + 1))
            else
               echo "âœ… Final newline is present."
            fi
          done

          if [ $ERROR_COUNT -ne 0 ]; then
            echo "--------------------------------------------------"
            echo "ğŸš¨ FAILED: Found $ERROR_COUNT formatting errors."
            exit 1
          fi

      - name: 2. Setup Mock U-Boot Environment (v2025.01)
        run: |
          echo ">>> Building Mock U-Boot Tree (Simulating v2025.01)..."
          mkdir -p mock-uboot
          cd mock-uboot
          
          # åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„
          mkdir -p arch/arm/dts/allwinner
          mkdir -p arch/arm/mach-sunxi
          mkdir -p configs
          mkdir patches
          
          # Mock 1: arch/arm/dts/Makefile
          cat <<EOF > arch/arm/dts/Makefile
          dtb-\$(CONFIG_MACH_SUN8I) += suniv.dtb
          EOF

          # Mock 2: arch/arm/mach-sunxi/board.c
          # v2025.01 ä¸­ board_init_f å¤§çº¦åœ¨ 175 è¡Œ
          # æˆ‘ä»¬å…ˆå¡«å…… 174 è¡Œç©ºè¡Œ
          for i in {1..174}; do echo "" >> arch/arm/mach-sunxi/board.c; done
          
          # å†™å…¥å‡½æ•°ä¸Šä¸‹æ–‡ (æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨æ ‡å‡† Tab ç¼©è¿›ï¼Œè¡¥ä¸ä¼šæ ¹æ®æ­¤è¿›è¡ŒåŒ¹é…)
          # æ³¨æ„ï¼šcat å†…éƒ¨çš„ç¼©è¿›å¿…é¡»æ˜¯ Tab
          cat <<EOF >> arch/arm/mach-sunxi/board.c
          void board_init_f(ulong dummy)
          {
          	spl_init();
          	preloader_console_init();
          
          #if CONFIG_IS_ENABLED(I2C) && CONFIG_IS_ENABLED(SYS_I2C_LEGACY)
          EOF
          
          echo ">>> Mock board.c ready. 'spl_init();' is at line $(grep -n "spl_init" arch/arm/mach-sunxi/board.c | cut -d: -f1)."

      - name: 3. Quilt Apply Test
        run: |
          echo ">>> Attempting to apply patches using Quilt..."
          
          cd mock-uboot
          # å‡†å¤‡ patch series æ–‡ä»¶
          ls ../patches-uboot/*.patch | xargs -n 1 basename > patches/series
          
          # æ‹·è´å®é™…è¡¥ä¸
          cp ../patches-uboot/*.patch patches/
          
          echo "--- Patch Series ---"
          cat patches/series
          echo "--------------------"
          
          # åº”ç”¨è¡¥ä¸ (å¼ºåˆ¶è¦æ±‚ 0 åç§»ï¼Œä¸¥ä¸åˆç¼)
          if quilt push -a --fuzz=0; then
            echo "ğŸ‰ SUCCESS: All patches applied perfectly to v2025.01 structure!"
          else
            echo "ğŸ’¥ FAILED: Patch application failed."
            echo ">>> Current board.c content around target line:"
            sed -n '170,185p' arch/arm/mach-sunxi/board.c
            exit 1
          fi
