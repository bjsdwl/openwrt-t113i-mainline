name: 01 - Patch Lint & Validator (Quilt Mode)

on:
  push:
    paths:
      - 'patches-uboot/**'
      - '.github/workflows/check-patches.yml'
  workflow_dispatch:

jobs:
  strict_quilt_check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Quilt & Utils
        run: |
          sudo apt-get update
          sudo apt-get install -y quilt dos2unix

      - name: 1. Strict Syntax & EOL Check
        run: |
          echo ">>> Checking for Windows CRLF and Missing Newlines..."
          ERROR_COUNT=0
          cd patches-uboot
          
          for patchfile in *.patch; do
            echo "--------------------------------------------------"
            echo "ðŸ” Inspecting: $patchfile"
            
            # 1. CRLF Check
            if grep -U $'\r' "$patchfile" > /dev/null; then
              echo "âŒ CRITICAL ERROR: Found Windows CRLF line endings!"
              echo "   -> Please convert this file to UNIX (LF)."
              ERROR_COUNT=$((ERROR_COUNT + 1))
            else
              echo "âœ… Line endings are UNIX (LF)."
            fi

            # 2. Missing Newline at EOF Check
            # Using tail -c 1 combined with xxd to check the last byte
            LAST_CHAR=$(tail -c 1 "$patchfile" | xxd -p)
            if [ "$LAST_CHAR" != "0a" ]; then
               echo "âŒ CRITICAL ERROR: File does NOT end with a newline (0x0A)!"
               echo "   Current last byte hex: $LAST_CHAR"
               echo "   -> Please add an empty line at the very end of the file."
               ERROR_COUNT=$((ERROR_COUNT + 1))
            else
               echo "âœ… Final newline is present."
            fi
          done

          if [ $ERROR_COUNT -ne 0 ]; then
            echo "--------------------------------------------------"
            echo "ðŸš¨ FAILED: Found $ERROR_COUNT formatting errors."
            exit 1
          fi

      - name: 2. Setup Mock U-Boot Environment
        run: |
          echo ">>> Building Mock U-Boot Tree (Simulating 2025.01 Structure)..."
          mkdir -p mock-uboot
          cd mock-uboot
          
          # Create directories
          mkdir -p arch/arm/dts/allwinner
          mkdir -p arch/arm/mach-sunxi
          mkdir -p configs
          mkdir patches
          
          # Mock 1: arch/arm/dts/Makefile (Parent directory logic)
          cat <<EOF > arch/arm/dts/Makefile
          # sunxi
          dtb-\$(CONFIG_MACH_SUN8I) += suniv-f1c100s-licheepi-nano.dtb
          dtb-\$(CONFIG_MACH_SUN8I) += sun4i-a10-a1000.dtb
          EOF

          # Mock 2: arch/arm/mach-sunxi/board.c (For LED Debug Patch)
          # Note: We simulate enough lines to satisfy the patch context
          # The patch expects line 340, so we pad the file with newlines first
          for i in {1..339}; do echo "" >> arch/arm/mach-sunxi/board.c; done
          
          # Append the actual context content
          cat <<EOF >> arch/arm/mach-sunxi/board.c
          void board_init_f(ulong dummy)
          {
          	spl_init();
          	preloader_console_init();
          
          #if defined(CONFIG_SPL_I2C) && defined(CONFIG_SPL_SYS_I2C_LEGACY)
          EOF
          
          echo ">>> Mock environment ready."

      - name: 3. Quilt Apply Test
        run: |
          echo ">>> Attempting to apply patches using Quilt..."
          
          cd mock-uboot
          # Prepare series file
          ls ../patches-uboot/*.patch | sed 's|../patches-uboot/||g' > patches/series
          
          # Copy patches
          cp ../patches-uboot/*.patch patches/
          
          echo "--- Patch Series ---"
          cat patches/series
          echo "--------------------"
          
          # Apply patches strictly (no fuzz allowed)
          if quilt push -a --fuzz=0; then
            echo "ðŸŽ‰ SUCCESS: All patches applied perfectly!"
          else
            echo "ðŸ’¥ FAILED: Quilt could not apply patches."
            echo "--- Quilt Log ---"
            # Re-run to show error output
            quilt push -a --fuzz=0 || true
            exit 1
          fi
