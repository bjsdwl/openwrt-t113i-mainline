name: 01 - Strict Patch Validator (Quilt Mode)

on:
  push:
    paths:
      - 'patches-uboot/**'
      - '.github/workflows/check-patches.yml'
  workflow_dispatch:

jobs:
  strict_quilt_check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Quilt & Utils
        run: |
          sudo apt-get update
          sudo apt-get install -y quilt dos2unix

      - name: 1. Strict Syntax & EOL Check
        run: |
          echo ">>> Checking for Windows CRLF and Missing Newlines..."
          ERROR_COUNT=0
          cd patches-uboot
          
          for patchfile in *.patch; do
            echo "--------------------------------------------------"
            echo "ğŸ” Inspecting: $patchfile"
            
            # æ£€æŸ¥ 1: æ˜¯å¦åŒ…å« Windows CRLF (\r\n)
            # grep -U $'\r' ä¼šæ‰¾å‡ºåŒ…å«å›è½¦ç¬¦çš„è¡Œ
            if grep -U $'\r' "$patchfile" > /dev/null; then
              echo "âŒ CRITICAL ERROR: Found Windows CRLF line endings!"
              echo "   OpenWrt patch utility requires UNIX (LF) line endings."
              echo "   -> Please convert this file using 'dos2unix' or VS Code (LF mode)."
              ERROR_COUNT=$((ERROR_COUNT + 1))
            else
              echo "âœ… Line endings are UNIX (LF)."
            fi

            # æ£€æŸ¥ 2: æ–‡ä»¶æœ«å°¾æ˜¯å¦ç¼ºå°‘æ¢è¡Œç¬¦
            # è¿™æ˜¯ä¸€ä¸ªæéš¾å‘ç°çš„é”™è¯¯ï¼Œä¼šå¯¼è‡´ "unexpected end of file"
            # tail -c 1 è¯»å–æœ€åä¸€ä¸ªå­—èŠ‚ï¼Œwc -l ç»Ÿè®¡è¡Œæ•°ã€‚å¦‚æœæœ€åä¸€ä¸ªå­—èŠ‚ä¸æ˜¯æ¢è¡Œï¼Œwc -l ä¼šè¿”å› 0 (åœ¨æŸäº› shell ä¸‹)
            # æ›´ç¨³å¦¥çš„æ–¹æ³•æ˜¯ç›´æ¥æ£€æµ‹æœ€åä¸€ä¸ªå­—ç¬¦
            LAST_CHAR=$(tail -c 1 "$patchfile" | xxd -p)
            if [ "$LAST_CHAR" != "0a" ]; then
               echo "âŒ CRITICAL ERROR: File does NOT end with a newline (0x0A)!"
               echo "   Current last byte hex: $LAST_CHAR"
               echo "   -> Please add an empty line at the very end of the file."
               ERROR_COUNT=$((ERROR_COUNT + 1))
            else
               echo "âœ… Final newline is present."
            fi
          done

          if [ $ERROR_COUNT -ne 0 ]; then
            echo "--------------------------------------------------"
            echo "ğŸš¨ FAILED: Found $ERROR_COUNT formatting errors."
            exit 1
          fi

      - name: 2. Setup Mock Environment (Match 2025.01 Structure)
        run: |
          echo ">>> Building Mock U-Boot Tree..."
          mkdir -p mock-uboot
          cd mock-uboot
          
          # æ¨¡æ‹Ÿ U-Boot 2025.01 ç›®å½•ç»“æ„
          mkdir -p arch/arm/dts/allwinner
          mkdir -p configs
          
          # æ¨¡æ‹Ÿ arch/arm/dts/Makefile (çˆ¶ç›®å½•ç®¡ç†æ¨¡å¼)
          cat <<EOF > arch/arm/dts/Makefile
          # sunxi
          dtb-\$(CONFIG_MACH_SUN8I) += suniv-f1c100s-licheepi-nano.dtb
          dtb-\$(CONFIG_MACH_SUN8I) += sun4i-a10-a1000.dtb
          EOF
          
          # åˆå§‹åŒ– Quilt ç¯å¢ƒ
          mkdir patches
          echo ">>> Mock environment ready."

      - name: 3. Quilt Apply Test
        run: |
          echo ">>> Attempting to apply patches using Quilt..."
          
          # å‡†å¤‡ Quilt series æ–‡ä»¶
          cd mock-uboot
          ls ../patches-uboot/*.patch > patches/series
          
          # ä¿®æ­£ series æ–‡ä»¶è·¯å¾„ï¼ˆå»æ‰ç›¸å¯¹è·¯å¾„ï¼Œåªç•™æ–‡ä»¶åï¼‰
          sed -i 's|../patches-uboot/||g' patches/series
          
          # å¤åˆ¶è¡¥ä¸æ–‡ä»¶åˆ° quilt ç›®å½•
          cp ../patches-uboot/*.patch patches/
          
          # æ˜¾ç¤ºè¦åº”ç”¨çš„è¡¥ä¸åˆ—è¡¨
          echo "--- Patch Series ---"
          cat patches/series
          echo "--------------------"
          
          # ä½¿ç”¨ Quilt å¼ºåŠ›åº”ç”¨
          # push -a: åº”ç”¨æ‰€æœ‰è¡¥ä¸
          # --fuzz=0: ä¸¥ç¦æ¨¡ç³ŠåŒ¹é… (OpenWrt é»˜è®¤è¡Œä¸º)
          if quilt push -a --fuzz=0; then
            echo "ğŸ‰ SUCCESS: All patches applied perfectly with Quilt!"
          else
            echo "ğŸ’¥ FAILED: Quilt could not apply patches."
            echo "--- Quilt Log ---"
            quilt push -a --fuzz=0 || true
            exit 1
          fi
