name: 01 - Patch Lint & Validator

on:
  push:
    paths:
      - 'patches-uboot/**'
      - '.github/workflows/check-patches.yml'
  workflow_dispatch:

jobs:
  validate_patches:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Mock U-Boot Tree
        run: |
          echo ">>> Creating a mock U-Boot environment for testing patches..."
          mkdir -p mock-uboot/arch/arm/dts/allwinner
          mkdir -p mock-uboot/configs
          
          # åˆ›å»ºå¿…é¡»å­˜åœ¨çš„ Makefile åŸºç¡€å†…å®¹ï¼Œæ¨¡æ‹Ÿä¸»çº¿ U-Boot çŽ¯å¢ƒ
          cat <<EOF > mock-uboot/arch/arm/dts/Makefile
          # sunxi
          dtb-\$(CONFIG_MACH_SUN8I) += some-other-board.dtb
          EOF
          
          echo ">>> Mock environment ready."

      - name: Validate Patch Syntax & Integrity
        run: |
          ERROR_COUNT=0
          cd patches-uboot
          
          for patchfile in *.patch; do
            echo "--------------------------------------------------"
            echo "ðŸ” Testing Patch: $patchfile"
            
            # 1. æ£€æŸ¥æœ«å°¾æ¢è¡Œç¬¦ (é˜²æ­¢ "unexpected end of file")
            if [ -n "$(tail -c 1 "$patchfile")" ]; then
              echo "âŒ ERROR: Patch '$patchfile' does not end with a newline!"
              echo "   (This will cause OpenWrt build to fail)"
              ERROR_COUNT=$((ERROR_COUNT + 1))
            else
              echo "âœ… Newline check passed."
            fi
            
            # 2. æ£€æŸ¥åŸºæœ¬ Unified Diff ç»“æž„
            if grep -q "^--- " "$patchfile" && grep -q "^+++ " "$patchfile" && grep -q "^@@ " "$patchfile"; then
              echo "âœ… Unified Diff structure looks valid."
            else
              echo "âŒ ERROR: Patch '$patchfile' is not a valid Unified Diff!"
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
          done
          
          if [ $ERROR_COUNT -ne 0 ]; then
            echo "--------------------------------------------------"
            echo "âŒ Total $ERROR_COUNT critical errors found in patches."
            exit 1
          fi

      - name: Dry-run Apply Patches
        run: |
          echo ">>> Attempting to apply patches to mock tree..."
          cd mock-uboot
          
          for patch in ../patches-uboot/*.patch; do
            echo "ðŸ§ª Dry-running $patch..."
            # -p1 æ˜¯ OpenWrt é»˜è®¤ä½¿ç”¨çš„ strip å±‚çº§
            if patch -p1 --dry-run < "$patch"; then
              echo "âœ… $patch applied successfully (Dry-run)."
            else
              echo "âŒ ERROR: $patch FAILED to apply! Check paths or hunk context."
              exit 1
            fi
          done
          
          echo "ðŸŽ‰ All patches are syntactically correct and applicable!"
