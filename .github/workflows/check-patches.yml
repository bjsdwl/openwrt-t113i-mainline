name: 01 - Patch Lint & Validator (Real Source Mode)

on:
  push:
    paths:
      - 'patches-uboot/**'
      - '.github/workflows/check-patches.yml'
  workflow_dispatch:

jobs:
  real_source_check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout User Patches
        uses: actions/checkout@v4

      - name: Install Quilt & Utils
        run: |
          sudo apt-get update
          sudo apt-get install -y quilt dos2unix

      - name: 1. Strict Syntax & EOL Check
        run: |
          echo ">>> Checking for Windows CRLF and Missing Newlines..."
          cd patches-uboot
          for patchfile in *.patch; do
            if grep -U $'\r' "$patchfile" > /dev/null; then
              echo "âŒ ERROR: Windows CRLF found in $patchfile"
              exit 1
            fi
            if [ "$(tail -c 1 "$patchfile" | xxd -p)" != "0a" ]; then
               echo "âŒ ERROR: No newline at EOF in $patchfile"
               exit 1
            fi
          done
          echo "âœ… Patch formatting is clean."

      - name: 2. Download Real U-Boot v2025.01
        run: |
          echo ">>> Cloning U-Boot v2025.01 (Shallow)..."
          git clone --depth 1 https://github.com/u-boot/u-boot.git -b v2025.01 u-boot-src

      - name: 3. Quilt Apply Test (Real Source)
        run: |
          cd u-boot-src
          mkdir patches
          # æ‹·è´ä½ çš„è¡¥ä¸åˆ°çœŸå®žæºç ç›®å½•
          cp ../patches-uboot/*.patch patches/
          # ç”Ÿæˆè¡¥ä¸é˜Ÿåˆ—
          ls patches/*.patch | xargs -n 1 basename > patches/series
          
          echo ">>> Attempting to apply patches to REAL v2025.01 source..."
          # æ‰§è¡Œä¸¥æ ¼æ ¡éªŒï¼Œä¸å…è®¸ä»»ä½• fuzz
          if quilt push -a --fuzz=0; then
            echo "ðŸŽ‰ SUCCESS: All patches applied perfectly to real U-Boot v2025.01 source!"
          else
            echo "ðŸ’¥ FAILED: Patch application failed on real source."
            # å¦‚æžœå¤±è´¥ï¼Œæ˜¾ç¤ºå‡ºé”™æ–‡ä»¶é™„è¿‘çš„çœŸå®žå†…å®¹ä¾›å‚è€ƒ
            echo ">>> [DEBUG] Real content of arch/arm/mach-sunxi/board.c around line 175:"
            sed -n '170,185p' arch/arm/mach-sunxi/board.c | cat -A
            exit 1
          fi
