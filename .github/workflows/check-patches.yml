name: 01 - Patch Lint & Validator

on:
  push:
    paths:
      - 'patches-uboot/**'
      - '.github/workflows/check-patches.yml'
  workflow_dispatch:

jobs:
  validate_patches:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Mock U-Boot Tree (Official 2025.01 Structure)
        run: |
          echo ">>> Creating a mock U-Boot 2025.01 environment..."
          # 1. åˆ›å»ºå­ç›®å½•å­˜æ”¾ DTS (ä¸»çº¿ 2025.01 è§„èŒƒ)
          mkdir -p mock-uboot/arch/arm/dts/allwinner
          mkdir -p mock-uboot/configs
          
          # 2. åœ¨çˆ¶ç›®å½•åˆ›å»º Makefile (ä¸»çº¿ 2025.01 è§„èŒƒï¼šæ‰€æœ‰ sunxi è§„åˆ™éƒ½åœ¨æ­¤æ–‡ä»¶ä¸­)
          cat <<EOF > mock-uboot/arch/arm/dts/Makefile
          # sunxi
          dtb-\$(CONFIG_MACH_SUN8I) += suniv-f1c100s-licheepi-nano.dtb
          dtb-\$(CONFIG_MACH_SUN8I) += sun4i-a10-a1000.dtb
          EOF
          
          echo ">>> Mock environment ready at mock-uboot/"

      - name: Validate Patch Syntax & Integrity
        run: |
          ERROR_COUNT=0
          cd patches-uboot
          
          for patchfile in *.patch; do
            echo "--------------------------------------------------"
            echo "ğŸ” Testing Patch: $patchfile"
            
            # 1. æ£€æŸ¥æœ«å°¾æ¢è¡Œç¬¦ (é˜²æ­¢ "unexpected end of file" æŠ¥é”™)
            if [ -n "$(tail -c 1 "$patchfile")" ]; then
              echo "âŒ ERROR: Patch '$patchfile' does not end with a newline!"
              echo "   (This is required by the 'patch' utility in OpenWrt)"
              ERROR_COUNT=$((ERROR_COUNT + 1))
            else
              echo "âœ… Newline check passed."
            fi
            
            # 2. æ£€æŸ¥åŸºæœ¬ Unified Diff ç»“æ„ (å¿…é¡»å«æœ‰ ---, +++, @@)
            if grep -q "^--- " "$patchfile" && grep -q "^+++ " "$patchfile" && grep -q "^@@ " "$patchfile"; then
              echo "âœ… Unified Diff structure looks valid."
            else
              echo "âŒ ERROR: Patch '$patchfile' is not a valid Unified Diff!"
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
          done
          
          if [ $ERROR_COUNT -ne 0 ]; then
            echo "--------------------------------------------------"
            echo "âŒ Total $ERROR_COUNT critical errors found in patches."
            exit 1
          fi

      - name: Dry-run Apply Patches
        run: |
          echo ">>> Attempting to apply patches to mock tree..."
          cd mock-uboot
          
          # æŒ‰é¡ºåºé¢„æ¼”è¡¥ä¸åº”ç”¨
          # é‡‡ç”¨ -p1 strip å±‚çº§ï¼Œæ¨¡æ‹Ÿ OpenWrt è¡Œä¸º
          for patch in ../patches-uboot/*.patch; do
            echo "ğŸ§ª Dry-running $patch..."
            if patch -p1 --dry-run < "$patch"; then
              echo "âœ… $patch applied successfully (Dry-run)."
            else
              echo "âŒ ERROR: $patch FAILED to apply! Check paths or hunk context."
              exit 1
            fi
          done
          
          echo "ğŸ‰ All patches are syntactically correct and match U-Boot 2025.01 structure!"
          
