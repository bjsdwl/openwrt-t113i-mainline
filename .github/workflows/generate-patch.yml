name: 02 - Automatic Patch Generator (Quilt Mode)

on:
  workflow_dispatch: # 手动触发

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Install Quilt
        run: |
          sudo apt-get update
          sudo apt-get install -y quilt

      - name: Download U-Boot Source
        run: |
          # 下载官方 v2025.01 源码
          wget https://github.com/u-boot/u-boot/archive/refs/tags/v2025.01.tar.gz
          tar -zxf v2025.01.tar.gz
          mv u-boot-2025.01 u-boot-src

      - name: Quilt Patch Generation (Stable Version)
        run: |
          cd u-boot-src
          mkdir patches
          export QUILT_PATCHES=patches
          
          quilt new 003-early-debug-led.patch
          quilt add arch/arm/mach-sunxi/board.c
          
          # 构造最简化的稳定版调试代码
          # 功能：仅点亮 PC0 LED，作为 SPL 运行状态指示
          printf "\n\t/* --- STATUS LED PC0 ON --- */\n" > snippet.txt
          printf "\t*(volatile unsigned int *)(0x02000060) = (*(volatile unsigned int *)(0x02000060) & 0xFFFFFFF0) | 0x00000001;\n" >> snippet.txt
          printf "\t*(volatile unsigned int *)(0x02000070) |= 0x00000001;\n" >> snippet.txt
          
          # 定位 spl_init(); 并在其后插入
          TARGET_LINE=$(grep -n "spl_init();" arch/arm/mach-sunxi/board.c | cut -d: -f1 | head -n 1)
          sed -i "${TARGET_LINE}r snippet.txt" arch/arm/mach-sunxi/board.c
          
          # 刷新补丁生成文件
          quilt refresh
          
          # 拷贝回仓库的 patches-uboot 目录
          mkdir -p ../patches-uboot
          cp patches/003-early-debug-led.patch ../patches-uboot/

      - name: Commit and Push Clean Patch
        run: |
          git config --global user.name "actions-user"
          git config --global user.email "actions@github.com"
          git add patches-uboot/003-early-debug-led.patch
          git commit -m "chore: clean up 003 debug patch (keep led only)" || exit 0
          git push
