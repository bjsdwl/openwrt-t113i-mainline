name: T113-i Patch Factory (V5 - User Golden Diag)

on:
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git quilt libssl-dev device-tree-compiler perl

      - name: Prepare Source Environment
        run: |
          git clone --depth=1 https://github.com/openwrt/openwrt.git -b master openwrt
          cd openwrt
          ./scripts/feeds update -a && ./scripts/feeds install uboot-sunxi
          echo "CONFIG_TARGET_sunxi=y" > .config
          echo "CONFIG_TARGET_sunxi_cortexa7=y" >> .config
          echo "CONFIG_TARGET_sunxi_cortexa7_DEVICE_xunlong_orangepi-one=y" >> .config
          echo "CONFIG_PACKAGE_uboot-sunxi-orangepi_one=y" >> .config
          make defconfig
          make package/boot/uboot-sunxi/prepare V=s

      - name: "ğŸ’‰ SURGERY: Integrate Golden Snippet"
        run: |
          UBOOT_PATH=$(find openwrt/build_dir -name "u-boot-20*" -type d | head -n 1)
          cd $UBOOT_PATH

          # 010, 020 è¡¥ä¸ä¿æŒä¹‹å‰çš„é€»è¾‘ (DTS å’Œ Binman Offset)
          # é‡ç‚¹ä¿®æ”¹ 030 è¯Šæ–­è¡¥ä¸ï¼Œå®Œå…¨é‡‡ç”¨ä½ æä¾›çš„å¯„å­˜å™¨é€»è¾‘

          quilt new 030-golden-diag.patch
          quilt add arch/arm/mach-sunxi/board.c
          
          cat << 'EOF' > injection.c
          void board_init_f(ulong dummy)
          {
          	/* --- USER GOLDEN DIAGNOSTIC (Triple-Key + LED + UART Fix) --- */
          	{
          		volatile unsigned int *ccu_uart_bgr = (volatile unsigned int *)0x0200190C;
          		volatile unsigned int *mystery      = (volatile unsigned int *)0x02000128;
          		volatile unsigned int *pg_cfg2      = (volatile unsigned int *)0x020000E0;
          		volatile unsigned int *pc_cfg       = (volatile unsigned int *)0x02000060;
          		volatile unsigned int *pc_dat       = (volatile unsigned int *)0x02000070;
          		volatile unsigned int *u0           = (volatile unsigned int *)0x02500000;

          		/* 1. è§£é”æ€»çº¿é—¨æ§ä¸å¤ä½ (UART0 BGR) */
          		*ccu_uart_bgr = 0x00010001;

          		/* 2. è§£é” PG ç”µæºå¹¶è®¾ç½® PG17/18 ä¸º Func 7 (UART0) */
          		*mystery = (*mystery & ~(0xFF << 4)) | (0x77 << 4);
          		*pg_cfg2 = (*pg_cfg2 & ~(0xFF << 4)) | (0x77 << 4);

          		/* 3. ç‚¹äº® PC0 LED (è¯æ˜ä»£ç å·²æ‰§è¡Œ) */
          		*pc_cfg = (*pc_cfg & ~0xF) | 1;
          		*pc_dat |= 1;

          		/* 4. ç¡¬æ ¸æ³¢ç‰¹ç‡ä¿®æ­£ (Force 115200 @ 24MHz) */
          		u0[3] = 0x83;  /* LCR: DLAB=1, 8N1 */
          		u0[0] = 0x0D;  /* DLL: 13 (24MHz / (16 * 115200) = 13.02) */
          		u0[1] = 0x00;  /* DLM: 0 */
          		u0[3] = 0x03;  /* LCR: DLAB=0, 8N1 */

          		/* 5. å‘é€æµ‹è¯•å­—ç¬¦ 'K' */
          		u0[0] = 0x4B; 
          	}

          	/* ç»§ç»­æ‰§è¡ŒåŸæœ‰æµç¨‹ */
          	sunxi_sram_init();
          	tzpc_init();
          	clock_init();
          	timer_init();
          	gpio_init();
          	spl_init();
          	preloader_console_init();
          }
          EOF

          # ä½¿ç”¨ perl æ›¿æ¢æ•´ä¸ª board_init_f å‡½æ•°å¼€å¤´ç›´åˆ° preloader_console_init ä¹‹å‰
          # è¿™æ ·å¯ä»¥ç¡®ä¿æˆ‘ä»¬çš„æš´åŠ›è¯Šæ–­åœ¨æœ€å‰é¢
          perl -i -p0e 's/void board_init_f\(ulong dummy\).*?preloader_console_init\(\);/`cat injection.c`/se' arch/arm/mach-sunxi/board.c
          
          quilt refresh

          # 099 Morphing è¡¥ä¸ (å…¨é‡ DDR3 å‚æ•°) ä¿æŒä¸å˜
          # è¿™é‡Œä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œå‡è®¾ 099 å·²å­˜åœ¨äºä½ çš„ç¯å¢ƒä¸­

      - name: Sync and Commit
        run: |
          # ä¿æŒä¹‹å‰çš„ git commit é€»è¾‘
