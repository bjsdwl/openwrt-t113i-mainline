name: 02 - Automatic Patch Generator (Quilt Mode)

on:
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Install Quilt
        run: |
          sudo apt-get update
          sudo apt-get install -y quilt

      - name: Download U-Boot Source
        run: |
          wget https://github.com/u-boot/u-boot/archive/refs/tags/v2025.01.tar.gz
          tar -zxf v2025.01.tar.gz
          mv u-boot-2025.01 u-boot-src

      - name: Quilt Patch Generation
        run: |
          cd u-boot-src
          mkdir patches
          export QUILT_PATCHES=patches
          
          quilt new 003-early-debug-led.patch
          quilt add arch/arm/mach-sunxi/board.c
          
          # 使用 printf 逐行生成临时代码块，确保 Tab 缩进 (\t) 正确
          printf "\n\t/* --- QUILT GENERATED DEBUG START --- */\n" > snippet.txt
          printf "\t*(volatile unsigned int *)(0x0200190C) |= 0x00010001;\n" >> snippet.txt
          printf "\t*(volatile unsigned int *)(0x02000128) = (*(volatile unsigned int *)(0x02000128) & 0xFFFFF00F) | 0x00000770;\n" >> snippet.txt
          printf "\t*(volatile unsigned int *)(0x0250000C) = 0x83;\n" >> snippet.txt
          printf "\t*(volatile unsigned int *)(0x02500000) = 0x0D;\n" >> snippet.txt
          printf "\t*(volatile unsigned int *)(0x02500004) = 0x00;\n" >> snippet.txt
          printf "\t*(volatile unsigned int *)(0x0250000C) = 0x03;\n" >> snippet.txt
          printf "\t*(volatile unsigned int *)(0x02500008) = 0x07;\n" >> snippet.txt
          printf "\t*(volatile unsigned int *)(0x02500000) = 0x55;\n" >> snippet.txt
          printf "\t*(volatile unsigned int *)(0x02000060) = (*(volatile unsigned int *)(0x02000060) & 0xFFFFFFF0) | 0x00000001;\n" >> snippet.txt
          printf "\t{ volatile int loop, i; for(loop=0; loop<5; loop++) { *(volatile unsigned int *)(0x02000070) &= ~1; for(i=0; i<500000; i++); *(volatile unsigned int *)(0x02000070) |= 1; for(i=0; i<500000; i++); } }\n" >> snippet.txt
          printf "\t/* --- QUILT GENERATED DEBUG END --- */\n" >> snippet.txt
          
          # 插入代码到 spl_init(); 之后
          TARGET_LINE=$(grep -n "spl_init();" arch/arm/mach-sunxi/board.c | cut -d: -f1 | head -n 1)
          sed -i "${TARGET_LINE}r snippet.txt" arch/arm/mach-sunxi/board.c
          
          quilt refresh
          mkdir -p ../patches-uboot
          cp patches/003-early-debug-led.patch ../patches-uboot/

      - name: Commit and Push
        run: |
          git config --global user.name "actions-user"
          git config --global user.email "actions@github.com"
          git add patches-uboot/003-early-debug-led.patch
          git commit -m "chore: auto-generate 003 debug patch" || exit 0
          git push
