name: T113-i U-Boot Build (Nagami Step 1)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths: [ 'patches-uboot/**', '.github/workflows/build.yml' ]

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialization Environment
        run: |
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install build-essential git wget python3 u-boot-tools xxd
          sudo mkdir -p /workdir && sudo chown $USER:$GROUPS /workdir

      - name: Clone Source Code
        run: |
          cd /workdir
          git clone --depth 1 https://github.com/openwrt/openwrt.git openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

      - name: Update & Install Feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a && ./scripts/feeds install -a
          ./scripts/feeds install uboot-sunxi

      - name: Configure and Patch
        run: |
          cd openwrt
          cp $GITHUB_WORKSPACE/seed.config .config
          chmod +x $GITHUB_WORKSPACE/diy-part2.sh
          $GITHUB_WORKSPACE/diy-part2.sh
          make defconfig

      - name: Compile U-Boot
        run: |
          cd openwrt
          make package/boot/uboot-sunxi/compile -j$(nproc) V=s

      - name: Assemble Step 1 Image
        run: |
          mkdir -p $GITHUB_WORKSPACE/outputs
          cd openwrt
          SPL_FILE=$(find build_dir/target-* -name "sunxi-spl.bin" | grep "/spl/" | head -n 1)
          cp "$SPL_FILE" spl_step1.bin
          
          # 修复 eGON Checksum (这是 BROM 的入场券)
          python3 -c "
          import struct
          with open('spl_step1.bin', 'rb') as f: data = bytearray(f.read())
          length = (len(data) + 3) & ~3
          data = data.ljust(length, b'\x00')
          struct.pack_into('<I', data, 0x10, length)
          checksum = 0
          for i in range(0, length, 4):
              val = 0x5F0A6C39 if i == 0x0c else struct.unpack('<I', data[i:i+4])[0]
              checksum = (checksum + val) & 0xFFFFFFFF
          struct.pack_into('<I', data, 0x0c, checksum)
          with open('spl_step1_signed.bin', 'wb') as f: f.write(data)
          "
          
          # 输出最终烧录文件 (仅包含 SPL，用于 Step 1 验证)
          cp spl_step1_signed.bin $GITHUB_WORKSPACE/outputs/t113i-spl-step1.bin

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: T113i-SPL-Step1
          path: ${{ github.workspace }}/outputs/*
