name: T113-i Source Scouting (Fetch & Dump)

on:
  workflow_dispatch:

jobs:
  recon:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker image prune --all --force

      - name: Prepare OpenWrt & U-Boot Source
        run: |
          # 1. å…‹éš† OpenWrt å¹¶æ›´æ–° U-Boot è½¯ä»¶åŒ…
          git clone --depth 1 https://github.com/openwrt/openwrt.git openwrt
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install uboot-sunxi
          
          # 2. ç”Ÿæˆæœ€å°åŒ–é…ç½®ä»¥æ»¡è¶³ prepare ä¾èµ–
          echo "CONFIG_TARGET_sunxi=y" > .config
          echo "CONFIG_TARGET_sunxi_cortexa7=y" >> .config
          make defconfig
          
          # 3. æ‰§è¡Œ prepareï¼Œä¸‹è½½å¹¶è§£å‹ U-Boot 2025.01 æºç 
          # è¿™é‡Œä½¿ç”¨äº† V=s ä»¥ä¾¿ç¡®è®¤ prepare åŠ¨ä½œæ˜¯å¦æˆåŠŸå®Œæˆ
          make package/boot/uboot-sunxi/prepare V=s

      - name: "ğŸ•µï¸ DUMPING: Original Source Files"
        run: |
          # å¯»æ‰¾è§£å‹åçš„ U-Boot æºç ç›®å½•
          UBOOT_DIR=$(find openwrt/build_dir -type d -name "u-boot-2025.01" | head -n 1)
          if [ -z "$UBOOT_DIR" ]; then
            echo "âŒ Error: Could not find U-Boot source directory!"
            exit 1
          fi
          echo ">>> Found U-Boot Directory: $UBOOT_DIR"
          echo ">>> Current Workspace: $(pwd)"

          echo "=================================================================="
          echo "FILE: configs/orangepi_one_defconfig"
          echo "=================================================================="
          cat "$UBOOT_DIR/configs/orangepi_one_defconfig"
          echo -e "\n\n"

          echo "=================================================================="
          echo "FILE: arch/arm/dts/sunxi-u-boot.dtsi"
          echo "=================================================================="
          if [ -f "$UBOOT_DIR/arch/arm/dts/sunxi-u-boot.dtsi" ]; then
            cat "$UBOOT_DIR/arch/arm/dts/sunxi-u-boot.dtsi"
          else
            echo "!!! File Not Found !!!"
          fi
          echo -e "\n\n"

          echo "=================================================================="
          echo "FILE: arch/arm/mach-sunxi/board.c"
          echo "=================================================================="
          if [ -f "$UBOOT_DIR/arch/arm/mach-sunxi/board.c" ]; then
            # ä»…æ‰“å° board_init_f å‡½æ•°é™„è¿‘çš„ä»£ç ï¼Œæ–¹ä¾¿å®šä½
            # æˆ–è€…ä¸ºäº†å®Œæ•´æ€§ç›´æ¥æ‰“å°å…¨æ–‡
            cat "$UBOOT_DIR/arch/arm/mach-sunxi/board.c"
          fi
          echo -e "\n\n"

          echo "=================================================================="
          echo "FILE: arch/arm/dts/Makefile"
          echo "=================================================================="
          if [ -f "$UBOOT_DIR/arch/arm/dts/Makefile" ]; then
            # æˆ‘ä»¬éœ€è¦çœ‹ sun8i-t113s é™„è¿‘çš„å†…å®¹ï¼Œä»¥ä¾¿çŸ¥é“åœ¨å“ªæ’å…¥æ–°ç›®æ ‡
            grep -C 5 "sun8i-t113s" "$UBOOT_DIR/arch/arm/dts/Makefile"
          fi
          echo -e "\n\n"
