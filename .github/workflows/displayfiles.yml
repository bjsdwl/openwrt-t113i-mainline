name: T113-i Source Scouting (Precision Dump)

on:
  workflow_dispatch:

jobs:
  scout:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker image prune --all --force

      - name: Prepare OpenWrt & Unpack U-Boot
        run: |
          echo ">>> 1. Cloning OpenWrt..."
          git clone --depth 1 https://github.com/openwrt/openwrt.git openwrt
          cd openwrt
          
          echo ">>> 2. Installing Feeds..."
          ./scripts/feeds update -a
          ./scripts/feeds install uboot-sunxi
          
          echo ">>> 3. Generating Minimal Config..."
          # å¿…é¡»é€‰ä¸­ sunxi æ¶æ„ï¼ŒOpenWrt æ‰ä¼šä¸‹è½½ uboot-sunxi çš„æºç 
          echo "CONFIG_TARGET_sunxi=y" > .config
          echo "CONFIG_TARGET_sunxi_cortexa7=y" >> .config
          make defconfig
          
          echo ">>> 4. Unpacking U-Boot Source (make prepare)..."
          # V=s æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—ï¼Œç¡®ä¿ä¸‹è½½è§£å‹æˆåŠŸ
          make package/boot/uboot-sunxi/prepare V=s

      - name: "ğŸ•µï¸ DUMPING: Target Source Files"
        run: |
          # 1. å®šä½ OpenWrt çš„åŒ…å®šä¹‰æ–‡ä»¶
          OW_MK="openwrt/package/boot/uboot-sunxi/Makefile"

          # 2. å®šä½è§£å‹åçš„ U-Boot æºç ç›®å½• (é€šå¸¸åœ¨ build_dir/target-.../u-boot-sunxi/u-boot-20xx.xx)
          # ä½¿ç”¨ find åŠ¨æ€æŸ¥æ‰¾ï¼Œé¿å…ç‰ˆæœ¬å·å˜åŠ¨å¯¼è‡´æ‰¾ä¸åˆ°
          UBOOT_SRC=$(find openwrt/build_dir -type d -name "u-boot-20*" | grep "u-boot-sunxi" | head -n 1)

          if [ -z "$UBOOT_SRC" ]; then
            echo "âŒ CRITICAL ERROR: U-Boot source directory not found!"
            exit 1
          fi

          echo ">>> U-Boot Source located at: $UBOOT_SRC"

          # å®šä¹‰æ‰“å°å‡½æ•°
          print_file() {
            local filepath=$1
            local description=$2
            echo -e "\n\n"
            echo "================================================================================"
            echo "FILE START: $description"
            echo "PATH: $filepath"
            echo "--------------------------------------------------------------------------------"
            if [ -f "$filepath" ]; then
              cat "$filepath"
            else
              echo "!!! FILE NOT FOUND !!!"
            fi
            echo "--------------------------------------------------------------------------------"
            echo "FILE END: $description"
            echo "================================================================================"
          }

          # --- å¼€å§‹æ‰“å°æˆ‘ä»¬éœ€è¦æ‰“è¡¥ä¸çš„æ–‡ä»¶ ---

          # 1. OpenWrt çš„ Makefile (ç”¨äºä¿®å¤æ„å»ºç³»ç»Ÿè¢«è·³è¿‡çš„é—®é¢˜)
          print_file "$OW_MK" "OpenWrt Package Makefile"

          # 2. U-Boot çš„ Defconfig (å°†è¢«é­”æ”¹çš„æ ¸å¿ƒé…ç½®)
          print_file "$UBOOT_SRC/configs/orangepi_one_defconfig" "Target Defconfig (To be hijacked)"

          # 3. U-Boot çš„ Board åˆå§‹åŒ–ä»£ç  (ç”¨äºç‰©ç†è§£é”ç”µæºå’ŒDDRæµ‹è¯•)
          print_file "$UBOOT_SRC/arch/arm/mach-sunxi/board.c" "Board Init C File (Unlock & Test)"

          # 4. U-Boot çš„é€šç”¨ DTSI (ç”¨äºä¿®æ”¹ Binman/SPL åç§»)
          print_file "$UBOOT_SRC/arch/arm/dts/sunxi-u-boot.dtsi" "Sunxi U-Boot DTSI (Offset fix)"

          # 5. U-Boot çš„ DTS Makefile (ç”¨äºæ³¨å†Œæ–°çš„è®¾å¤‡æ ‘)
          print_file "$UBOOT_SRC/arch/arm/dts/Makefile" "DTS Makefile (Register new board)"
