name: T113-i Source Scouting (Fix & Dump)

on:
  workflow_dispatch:

jobs:
  scout:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker image prune --all --force

      - name: Prepare OpenWrt & Unpack U-Boot
        run: |
          echo ">>> 1. Cloning OpenWrt..."
          git clone --depth 1 https://github.com/openwrt/openwrt.git openwrt
          cd openwrt
          
          echo ">>> 2. Installing Feeds..."
          ./scripts/feeds update -a
          ./scripts/feeds install uboot-sunxi
          
          echo ">>> 3. Generating Config (Force OrangePi One)..."
          # ÂÖ≥ÈîÆ‰øÆÊ≠£ÔºöÊòæÂºèÈÄâ‰∏≠ Orange Pi OneÔºåËß¶ÂèëÊ∫êÁ†ÅËß£Âéã
          echo "CONFIG_TARGET_sunxi=y" > .config
          echo "CONFIG_TARGET_sunxi_cortexa7=y" >> .config
          echo "CONFIG_TARGET_sunxi_cortexa7_DEVICE_xunlong_orangepi-one=y" >> .config
          echo "CONFIG_PACKAGE_uboot-sunxi-orangepi_one=y" >> .config
          make defconfig
          
          echo ">>> 4. Unpacking U-Boot Source (make prepare)..."
          # V=s ÊòæÁ§∫ËØ¶ÁªÜÊó•Âøó
          make package/boot/uboot-sunxi/prepare V=s

      - name: "üïµÔ∏è DUMPING: Target Source Files"
        run: |
          # 1. OpenWrt Package Makefile (ÂßãÁªàÂ≠òÂú®)
          OW_MK="openwrt/package/boot/uboot-sunxi/Makefile"

          # 2. ËØäÊñ≠ÁõÆÂΩïÁªìÊûÑ (‰ª•Èò≤ find Â§±Ë¥•ÔºåÂÖàÁúã‰∏ÄÁúº build_dir ÈáåÂà∞Â∫ïÊúâ‰ªÄ‰πà)
          echo ">>> DIAGNOSTICS: Listing build_dir structure..."
          find openwrt/build_dir -maxdepth 3 -type d || true

          # 3. Êö¥ÂäõÊü•Êâæ U-Boot Ê∫êÁ†ÅÁõÆÂΩï
          # Âè™Ë¶ÅÂêçÂ≠óÈáåÂ∏¶ u-boot-20 ‰∏îÊòØÁõÆÂΩïÂç≥ÂèØÔºåÊîæÂÆΩÈôêÂà∂
          UBOOT_SRC=$(find openwrt/build_dir -name "u-boot-20*" -type d | head -n 1)

          if [ -z "$UBOOT_SRC" ]; then
            echo "‚ùå CRITICAL ERROR: U-Boot source directory still not found!"
            echo ">>> Listing all directories in openwrt/build_dir:"
            ls -R openwrt/build_dir
            exit 1
          fi

          echo ">>> SUCCESS: U-Boot Source located at: $UBOOT_SRC"

          # ÂÆö‰πâÊâìÂç∞ÂáΩÊï∞
          print_file() {
            local filepath=$1
            local description=$2
            echo -e "\n\n"
            echo "================================================================================"
            echo "FILE START: $description"
            echo "PATH: $filepath"
            echo "--------------------------------------------------------------------------------"
            if [ -f "$filepath" ]; then
              cat "$filepath"
            else
              echo "!!! FILE NOT FOUND !!!"
            fi
            echo "--------------------------------------------------------------------------------"
            echo "FILE END: $description"
            echo "================================================================================"
          }

          # --- ÂºÄÂßãÊâìÂç∞ ---

          # 1. OpenWrt ÁöÑ Makefile
          print_file "$OW_MK" "OpenWrt Package Makefile"

          # 2. U-Boot ÁöÑ Defconfig
          print_file "$UBOOT_SRC/configs/orangepi_one_defconfig" "Target Defconfig"

          # 3. U-Boot ÁöÑ Board ÂàùÂßãÂåñ‰ª£Á†Å
          print_file "$UBOOT_SRC/arch/arm/mach-sunxi/board.c" "Board Init C File"

          # 4. U-Boot ÁöÑÈÄöÁî® DTSI (Binman Offset)
          print_file "$UBOOT_SRC/arch/arm/dts/sunxi-u-boot.dtsi" "Sunxi U-Boot DTSI"

          # 5. U-Boot ÁöÑ DTS Makefile
          print_file "$UBOOT_SRC/arch/arm/dts/Makefile" "DTS Makefile"
